// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BattleWinner {
  MODEL_A
  MODEL_B
  TIE
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique @db.VarChar(255)
  name      String   @db.VarChar(255)
  password  String   @db.VarChar(255)
  role      String   @default("user") @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  evaluations Evaluation[]
  judgeVotes  JudgeVote[]

  @@map("users")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  models Model[]

  @@map("organizations")
}

model Domain {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?
  icon        String?  @db.VarChar(10)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  testCases      TestCase[]
  evaluations    Evaluation[]
  modelRankings  ModelRanking[]
  battles        Battle[]

  @@map("domains")
}

model Model {
  id             String   @id @default(uuid()) @db.Uuid
  name           String   @db.VarChar(255)
  slug           String   @unique @db.VarChar(255)
  organizationId String   @map("organization_id") @db.Uuid
  description    String?
  version        String?  @db.VarChar(50)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization      Organization       @relation(fields: [organizationId], references: [id])
  evaluationModels  EvaluationModel[]
  modelRankings     ModelRanking[]
  battlesAsModelA   Battle[]           @relation("ModelA")
  battlesAsModelB   Battle[]           @relation("ModelB")

  @@map("models")
}

model TestCase {
  id              String   @id @default(uuid()) @db.Uuid
  domainId        String   @map("domain_id") @db.Uuid
  title           String   @db.VarChar(500)
  prompt          String
  expectedCriteria Json    @map("expected_criteria")
  difficulty      String?  @db.VarChar(50)
  tags            String[]
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  domain  Domain   @relation(fields: [domainId], references: [id])
  battles Battle[]

  @@map("test_cases")
}

model Evaluation {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  domainId    String   @map("domain_id") @db.Uuid
  status      String   @db.VarChar(50)
  totalBattles Int     @default(0) @map("total_battles")
  completedBattles Int @default(0) @map("completed_battles")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user             User?              @relation(fields: [userId], references: [id])
  domain           Domain             @relation(fields: [domainId], references: [id])
  evaluationModels EvaluationModel[]
  battles          Battle[]

  @@map("evaluations")
}

model EvaluationModel {
  evaluationId String @map("evaluation_id") @db.Uuid
  modelId      String @map("model_id") @db.Uuid

  evaluation Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  model      Model      @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@id([evaluationId, modelId])
  @@map("evaluation_models")
}

model ModelRanking {
  id             String    @id @default(uuid()) @db.Uuid
  domainId       String    @map("domain_id") @db.Uuid
  modelId        String    @map("model_id") @db.Uuid
  rank           Int
  eloScore       Int       @map("elo_score")
  wins           Int       @default(0)
  losses         Int       @default(0)
  ties           Int       @default(0)
  totalBattles   Int       @default(0) @map("total_battles")
  lastBattleAt   DateTime? @map("last_battle_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  domain Domain @relation(fields: [domainId], references: [id])
  model  Model  @relation(fields: [modelId], references: [id])

  @@unique([domainId, modelId])
  @@map("model_rankings")
}

model Battle {
  id            String       @id @default(uuid()) @db.Uuid
  evaluationId  String       @map("evaluation_id") @db.Uuid
  domainId      String       @map("domain_id") @db.Uuid
  testCaseId    String       @map("test_case_id") @db.Uuid
  modelAId      String       @map("model_a_id") @db.Uuid
  modelBId      String       @map("model_b_id") @db.Uuid
  responseA     String       @map("response_a")
  responseB     String       @map("response_b")
  winner        BattleWinner?
  judgeCount    Int          @default(0) @map("judge_count")
  status        String       @default("pending") @db.VarChar(50)
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  evaluation Evaluation  @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  domain     Domain      @relation(fields: [domainId], references: [id])
  testCase   TestCase    @relation(fields: [testCaseId], references: [id])
  modelA     Model       @relation("ModelA", fields: [modelAId], references: [id])
  modelB     Model       @relation("ModelB", fields: [modelBId], references: [id])
  judgeVotes JudgeVote[]

  @@map("battles")
}

model JudgeVote {
  id          String    @id @default(uuid()) @db.Uuid
  battleId    String    @map("battle_id") @db.Uuid
  judgeId     String?   @map("judge_id") @db.Uuid
  judgeName   String?   @map("judge_name") @db.VarChar(255)
  vote        BattleWinner
  reasoning   String?
  criteria    Json
  confidence  Int?
  createdAt   DateTime  @default(now()) @map("created_at")

  battle      Battle    @relation(fields: [battleId], references: [id], onDelete: Cascade)
  judge       User?     @relation(fields: [judgeId], references: [id])

  @@map("judge_votes")
}

model VerificationRecord {
  id          String   @id @default(uuid()) @db.Uuid
  recordType  String   @map("record_type") @db.VarChar(50)
  recordId    String   @map("record_id") @db.Uuid
  dataHash    String   @map("data_hash") @db.VarChar(64)
  metadata    Json?
  verifiedAt  DateTime @default(now()) @map("verified_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([recordType, recordId], name: "idx_verification_records_type_id")
  @@index([dataHash], name: "idx_verification_records_hash")
  @@map("verification_records")
}
